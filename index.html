<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shilahit Detox: tratamiento natural desintoxicante.</title>
  <meta name="description" content="Shilahit Detox: tratamiento natural desintoxicante. Resultados desde el primer mes. Compra con envío rápido y pago a contra entrega." />
  <meta name="keywords" content="Shilahit Detox: tratamiento natural desintoxicante. Resultados desde el primer mes. Compra con envío rápido y pago a contra entrega." />

  <!-- Preload imagen hero (prioritaria para LCP) -->
  <link rel="preload" as="image" href="imageneswebp/imagen1.webp" fetchpriority="high">

  <!-- Fuentes (no bloqueantes) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" as="style" onload="this.rel='stylesheet'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  </noscript>

  <style>
    :root{
      --red:#0c8b08; --red-dark:#0a6f06; --gold:#ffb300; --black:#0b0b0b;
      --surface:#111; --card:#151515; --muted:#b8c0cc;
      --ok:#10b981; --warn:#f59e0b; --ring:#ffffff22;
    }
    *{box-sizing:border-box}
    html,body{height:100%;scroll-behavior: smooth;}
    body{margin:0;background:linear-gradient(180deg,#0b0b0b,#121212 60%,#0b0b0b);color:#eaeaea;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:2px;overflow-x:hidden}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:100%;display:block;margin:0 1px;box-shadow:1px 1px 8px rgba(0,0,0,0.4);border-bottom:3px solid #fff;border-top:3px solid #fff}

    /* Botones */
    .btn{display:inline-flex;gap:.6rem;align-items:center;justify-content:center;padding:14px 22px;border-radius:999px;background:var(--red);font-weight:700;letter-spacing:.2px;width:100%;color:#fff;transition:.2s;margin:16px 2px;animation:heartbeat 1.5s ease-in-out infinite both;cursor:pointer}
    .btn:hover{background:var(--red-dark);transform:translateY(-1px)}
    .btn.outline{background:transparent;border:1px solid #ffffff33;animation:none}
    .contenedorbtn{display:flex;justify-content:center;margin-top:-20px;margin-bottom:-20px}
    .contenedorbtn .btn{position:fixed;bottom:6px;left:0;right:0;margin:0 auto;justify-content:center;background:red;gap:0 6px;padding:2px 6px;max-width:335px;z-index:9999}
    .contenedorbtn .btn span{color:yellow;font-size:23px}
    .llamado{font-size:1.2rem;font-weight:800}

    /* Modal */
    .modal-overlay{display:none;position:fixed;inset:0;background:#000a;backdrop-filter:blur(4px);align-items:center;justify-content:center;z-index:10000;padding:16px}
    .modal-overlay.active{display:flex}
    .modal{width:min(960px,100%);max-height:92vh;overflow:auto;background:#0e0e0e;border:1px solid rgba(255,255,255,0.08);border-radius:16px;box-shadow:0 30px 80px #000c}
    .modal header{top:0;background:#0e0e0ef2;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:center}
    .modal h3{margin:0;font-size:1.4rem}
    .modal .close{background:transparent;border:0;color:#fff;font-size:1.6rem;cursor:pointer;line-height:1}
    .modal .body{padding:18px}
    .modal .footer{padding:16px;border-top:1px solid rgba(255,255,255,0.06);display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}

    /* Ofertas */
    .offers{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 0 8px}
    .offer-card{display:grid;grid-template-columns:92px 1fr auto;gap:12px;align-items:center;padding:12px;border:1px solid rgba(255,255,255,0.05);border-radius:14px;background:#101010;cursor:pointer;transition:.18s}
    .offer-card:hover{border-color:rgba(255,255,255,0.14);transform:translateY(-2px)}
    .offer-card.active{outline:2px solid var(--red);box-shadow:0 0 0 4px rgba(255,255,255,0.06) inset}
    .offer-img{width:100%;height:100%;display:flex;align-items:center;justify-content:center; img {border: none;box-shadow: none;}}
    .offer-title{font-weight:700}
    .offer-badge{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);margin-left:6px}
    .badge-hot{background:#1e3a8a;color:#fff;border-color:transparent}
    .badge-save{background:#cf27dd;color:#fff;border-color:transparent;padding:3px 16px}
    .price{display:flex;flex-direction:column;align-items:flex-end}
    .price .compare{color:#94a3b8;text-decoration:line-through;font-size:.9rem}
    .price .current{font-size:1rem;font-weight:800}
    .totals{display:grid;gap:6px;padding:12px;border:1px dashed rgba(255,255,255,0.06);border-radius:12px;background:#0b0b0b;margin:8px 0 14px}
    .row{display:flex;justify-content:space-between;gap:12px}
    .row strong{font-weight:800}
    .muted{color:#a8b0b8;font-weight:400;font-size:.95rem}

    /* Layout */
    header.hero{position:relative;overflow:hidden;max-width:1200px;margin:-4px auto}
    header.hero img{width:100%;height:auto;display:block;object-fit:cover;content-visibility:auto;contain-intrinsic-size:600px}
    main{max-width:1100px;margin:4px auto;padding:0 2px}

    /* Form */
    #orderForm{padding:18px;display:grid;gap:14px;background:transparent}
    #orderForm div{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .in{width:100%;margin-top:6px;padding:12px 14px;border:1px solid #ffffff10;background:#0f0f0f;border-radius:12px;color:#eaeaea;outline:none}
    .in:focus{border-color:var(--gold);box-shadow:0 0 0 4px var(--ring)}
    label{display:block;font-weight:600}
    .error{border-color:#ef4444!important}
    #totalsBox{grid-template-columns: 1fr 1fr !important; .row{text-align: center;}}

    /* Input con ícono */
    .field{position:relative;display:block}
    .field .ico{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:18px;height:18px;opacity:.8;pointer-events:none;color:#b8c0cc}
    .in.with-ico{padding-left:44px}

    /* Toast */
    .toast{text-align: center; position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-10px);background:linear-gradient(90deg,#10b981,#059669);color:#fff;padding:12px 18px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.6);opacity:0;pointer-events:none;transition:opacity .25s ease, transform .25s ease;z-index:11000;font-weight:700}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}

    /* Upsell: tarjetas radio */
    .radio-card{display:flex;align-items:flex-start;gap:12px;padding:12px;border:1px solid rgba(255,255,255,0.08);border-radius:12px;background:#101010;cursor:pointer;transition:.18s;margin-bottom:10px}
    .radio-card:hover{border-color:rgba(255,255,255,0.18);transform:translateY(-1px)}
    .radio-card input[type="radio"]{margin-top:3px;accent-color:var(--red)}
    .radio-ui{display:grid;gap:4px}
    .radio-title{font-weight:800}

    /* Timer */
    .timer{display:flex;gap:0;justify-content:center;align-items:center;flex-wrap:wrap;width:30%}
    .timer .box{padding:2px;display:flex;flex-wrap:wrap;justify-content:center;align-items:center}

    @media (max-width:980px){
      #orderForm div{grid-template-columns:1fr;gap:12px}
      .offer-card{grid-template-columns:62px 1fr auto}
    }

    @keyframes heartbeat {
      from {transform: scale(1)}
      10% {transform: scale(0.91)}
      17% {transform: scale(0.98)}
      33% {transform: scale(0.87)}
      45% {transform: scale(1)}
    }
  </style>
</head>
<body>

  <header class="hero">
    <img src="imageneswebp/imagen1.webp" alt="Shilahit Detox" fetchpriority="high" decoding="async" width="1200" height="675">
  </header>

  <main>
    <img src="imageneswebp/imagen2.webp" alt="Producto Shilahit">
    <img src="imageneswebp/imagen3.webp" alt="Beneficios Shilahit">
    <img loading="lazy" decoding="async" src="imageneswebp/imagen4.webp" alt="">
    <img loading="lazy" decoding="async" src="imageneswebp/imagen5.webp" alt="">
    <img loading="lazy" decoding="async" src="imageneswebp/imagen6.webp" alt="">
    <img loading="lazy" decoding="async" src="imageneswebp/imagen7.webp" alt="">
    <img loading="lazy" decoding="async" src="imageneswebp/imagen8.webp" alt="">
    <img loading="lazy" decoding="async" src="imageneswebp/imagen9.webp" alt="" style="margin-bottom:150px">

    <div class="contenedorbtn">
      <a href="#checkout" class="btn" id="openCheckout" role="button">
        <span class="llamado">Obtener Oferta</span>
        <div class="timer" style="margin:0">
          <div style="width:90%;text-align:center"><span style="font-size:.9rem;color:#fff">Finaliza en</span></div>
          <div class="box"><div id="t-h" style="font-size:0.9rem">00</div></div>:
          <div class="box"><div id="t-m" style="font-size:0.9rem">59</div></div>:
          <div class="box"><div id="t-s" style="font-size:0.9rem">48</div></div>
        </div>
      </a>
    </div>
  </main>

  <!-- ===== MODAL DE OFERTAS ===== -->
  <div class="modal-overlay" id="checkoutModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal" role="document">
      <header>
        <div>
          <h3 id="modalTitle">Elije tu Oferta</h3>
          <div class="muted" id="modalSubtitle">Recuerda que pagas al recibir</div>
        </div>
        <button class="close" id="closeCheckout" aria-label="Cerrar">×</button>
      </header>

      <div class="body">
        <!-- Selector de ofertas --> <a href="#orderForm">
        <div class="offers" id="offerList">
          <div class="offer-card" data-offer="Compra 1" data-qty="1" data-price="89900" tabindex="0">
            <div class="offer-img"><img loading="lazy" src="imageneswebp/detoxsolo.webp" alt="Shilahit 1 frasco"></div>
            <div>
              <div class="offer-title">Solo Desintoxica</div>
              <div class="muted">1 Shilahit Detox (180 tabletas)</div>
              <span class="offer-badge badge-hot">Oferta</span>
            </div>
            <div class="price"><span class="current">$89.900</span></div>
          </div>

          <div class="offer-card" data-offer="Compra 1 + Virilex -50%" data-qty="2" data-price="149900" tabindex="0">
            <div class="offer-img"><img loading="lazy" src="imageneswebp/detoxh90.webp" alt="Shilahit x2"></div>
            <div>
              <div class="offer-title">Desintoxica y Restaura</div>
              <div class="muted">1 Shilahit Detox + Shilahit H90</div>
              <span class="offer-badge badge-hot">Soy Hombre</span>
            </div>
            <div class="price">
              <span class="compare">$180.000</span>
              <span class="current">$149.900</span>
            </div>
          </div>

          <div class="offer-card" data-offer="Compra 2 + 1 GRATIS" data-qty="3" data-price="149900" tabindex="0">
            <div class="offer-img"><img loading="lazy" src="imageneswebp/detoxm90.webp" alt="Shilahit 2+1"></div>
            <div>
              <div class="offer-title">Desintoxica y Restaura</div>
              <div class="muted">1 Shilahit Detox + Shilahit M90</div>
              <span class="offer-badge badge-save">Soy Mujer</span>
            </div>
            <div class="price">
              <span class="compare">$180.000</span>
              <span class="current">$149.900</span>
            </div>
          </div>
        </div></a>

        <!-- Formulario -->
        <form id="orderForm" class="glass" novalidate>
          <!-- Honeypot -->
          <input type="text" name="website" id="hp" style="position:absolute;left:-9999px;top:-9999px" tabindex="-1" autocomplete="off" aria-hidden="true">

          <div>
            <label>Nombre y Apellidos
              <span class="field">
                <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/></svg>
                <input required name="name" type="text" placeholder="Tu nombre completo" class="in with-ico" maxlength="80">
              </span>
            </label>

            <label>WhatsApp
              <span class="field">
                <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24 11.36 11.36 0 0 0 3.56.57 1 1 0 0 1 1 1v3.59a1 1 0 0 1-1 1A16 16 0 0 1 3 5a1 1 0 0 1 1-1h3.6a1 1 0 0 1 1 1 11.36 11.36 0 0 0 .57 3.56 1 1 0 0 1-.24 1.01Z"/></svg>
                <input required name="phone" type="tel" inputmode="numeric" placeholder="3xx xxx xxxx" class="in with-ico" maxlength="13">
              </span>
            </label>
          </div>

          <div>
            <label>Departamento
              <span class="field">
                <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5Z"/></svg>
                <select required name="state" class="in with-ico">
                  <option value="" selected disabled>Selecciona</option>
                  <option>Amazonas</option><option>Antioquia</option><option>Arauca</option><option>Atlántico</option>
                  <option>Bolívar</option><option>Boyacá</option><option>Caldas</option><option>Caquetá</option><option>Casanare</option><option>Cauca</option><option>Cesar</option>
                  <option>Chocó</option><option>Córdoba</option><option>Cundinamarca</option><option>Guainía</option><option>Guaviare</option><option>Huila</option><option>La Guajira</option>
                  <option>Magdalena</option><option>Meta</option><option>Nariño</option><option>Norte de Santander</option><option>Putumayo</option><option>Quindío</option><option>Risaralda</option>
                  <option>San Andrés y Providencia</option><option>Santander</option><option>Sucre</option><option>Tolima</option><option>Valle del Cauca</option><option>Vaupés</option><option>Vichada</option>
                </select>
              </span>
            </label>

            <label>Ciudad / Municipio
              <span class="field">
                <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a6 6 0 0 0-6 6c0 3.87 6 10 6 10s6-6.13 6-10a6 6 0 0 0-6-6Zm0 8a2 2 0 1 1 2-2 2 2 0 0 1-2 2Z"/></svg>
                <input required name="city" type="text" placeholder="Ej. Bogotá, Medellín" class="in with-ico" maxlength="60">
              </span>
            </label>
          </div>

          <label>Dirección de entrega
            <span class="field">
              <svg class="ico" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3Z"/></svg>
              <input required name="address" type="text" placeholder="Calle 00 # 00-00, apto, barrio" class="in with-ico" maxlength="120">
            </span>
          </label>

          <!-- (Opcional) select qty oculto, ya NO se usa para enviar -->
          <div style="display:none">
            <label style="display:none;">Cantidad
              <select name="qty" class="in">
                <option>1 Shilahit</option>
                <option>2 frascos</option>
                <option>3 frascos</option>
              </select>
            </label>
          </div>

          <!-- NUEVO: qty como hidden seguros -->
          <input type="hidden" name="qty" id="qtyField" value="">
          <input type="hidden" name="qty_num" id="qtyNumField" value="">

          <label style="display:flex;gap:10px;align-items:flex-start">
            <input type="checkbox" required name="terms" style="accent-color:var(--red)">
            <span class="muted">Acepto la política de tratamiento de datos y autorizo el contacto para coordinar el envío.</span>
          </label>

          <div class="totals" id="totalsBox" aria-live="polite">
            <div class="row"><span>Total</span><strong id="totalPrice">$0</strong></div>
            <div class="row"><span>Envío</span><strong class="accent">Gratis</strong></div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button type="submit" id="submitBtn" class="btn">
              <span class="btn-text">Confirmar pedido</span>
            </button>
          </div>

          <div id="formMsg" class="muted" role="status" aria-live="polite" style="margin-top:8px"></div>

          <!-- Valores ocultos de oferta para fallback -->
          <input type="hidden" name="offer" value="Compra 1">
          <input type="hidden" name="offer_price" value="150000">
        </form>

        <div id="formMount"></div>
      </div>

      <div class="footer">
        <small class="muted">Protegemos tus datos. Usamos la información únicamente para gestionar tu pedido.</small>
      </div>
    </div>
  </div>

  <!-- ===== MODAL UPSELL (simplificado: un botón Confirmar) ===== -->
  <div class="modal-overlay" id="upsellModal" role="dialog" aria-modal="true" aria-labelledby="upsellTitle" aria-hidden="true">
    <div class="modal" role="document">
      <header>
        <div>
          <h3 id="upsellTitle">Añade un Potenciador a mitad de precio</h3>
          <div class="muted">Precio regular $60.000 → Hoy <strong>$29.900</strong></div>
        </div>
        <button class="close" id="closeUpsell" aria-label="Cerrar">×</button>
      </header>

      <div class="body">
        <fieldset style="border:0;padding:0;margin:0">
          <legend class="muted" style="margin-bottom:8px">Elige tu opción antes de confirmar:</legend>

          <label class="radio-card">
            <input type="radio" name="upsell_option" value="Shilahit 2.0 Hombre">
            <div class="radio-ui">
              <div class="radio-title">Shilahit 2.0 (Hombre)</div>
              <div class="muted">Añadir por <strong>$29.900</strong></div>
            </div>
          </label>

          <label class="radio-card">
            <input type="radio" name="upsell_option" value="Shilahit FEM Mujer">
            <div class="radio-ui">
              <div class="radio-title">Shilahit FEM (Mujer)</div>
              <div class="muted">Añadir por <strong>$29.900</strong></div>
            </div>
          </label>

          <label class="radio-card">
            <input type="radio" name="upsell_option" value="Ninguno" checked>
            <div class="radio-ui">
              <div class="radio-title">No quiero el potenciador</div>
              <div class="muted">Continuar sin añadir</div>
            </div>
          </label>
        </fieldset>

        <div class="totals" id="upsellTotals" style="margin-top:12px">
          <div class="row"><span>Subtotal (tu selección)</span><strong id="upsellSubtotal">$0</strong></div>
          <div class="row"><span>Potenciador</span><strong id="upsellAddon">$0</strong></div>
          <div class="row"><span>Envío</span><strong>Gratis</strong></div>
          <div class="row"><span>Total</span><strong id="upsellTotal">$0</strong></div>
        </div>
      </div>

      <div class="footer" style="justify-content:flex-end">
        <button class="btn" id="upsellConfirm">Confirmar pedido</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">✅ Pedido enviado correctamente</div>

  <!-- JS -->
  <script>
    (function(){
      // URL del webhook (confirmado)
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby74C6ITsLLaJMw_JciXWFqYNr13EIW6CzDUlEh8xXjbXutwON_1mVg33mO6wH7FSfLWA/exec";

      // Elements
      const modal = document.getElementById('checkoutModal');
      const closeBtn = document.getElementById('closeCheckout');
      const cta = document.getElementById('openCheckout');
      const offerCards = Array.from(document.querySelectorAll('.offer-card'));
      const totalPrice = document.getElementById('totalPrice');
      const form = document.getElementById('orderForm');
      const formMsg = document.getElementById('formMsg');
      const submitBtn = document.getElementById('submitBtn');
      const toast = document.getElementById('toast');

      // Upsell
      const upsellModal = document.getElementById('upsellModal');
      const closeUpsellBtn = document.getElementById('closeUpsell');
      const upsellConfirm = document.getElementById('upsellConfirm');
      const upsellSubtotal = document.getElementById('upsellSubtotal');
      const upsellAddon = document.getElementById('upsellAddon');
      const upsellTotal = document.getElementById('upsellTotal');

      let selectedOffer = null;

      // Helpers
      function showToast(text){ toast.textContent = text; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 3000); }
      function formatCOP(n){ try { return n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); } catch(e){ return '$' + n; } }

      // Abrir/cerrar modal principal
      function openCheckout(e){ if(e) e.preventDefault(); modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open'); }
      if (cta){ ['click','touchstart'].forEach(ev=> cta.addEventListener(ev, openCheckout, {passive:false})); }
      document.querySelectorAll('a[href="#checkout"], a[href="#oferta"], [data-open-modal]').forEach(el=>{
        ['click','touchstart'].forEach(ev=> el.addEventListener(ev, openCheckout, {passive:false}));
      });
      function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); }
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeUpsell(); closeModal(); } });

      // Qty select oculto (no lo usamos para enviar, pero lo escondemos si existe)
      const qtySelect = form.querySelector('select[name="qty"]');
      if (qtySelect) { const qtyLabel = qtySelect.closest('label'); if (qtyLabel) qtyLabel.style.display = 'none'; }

      // NUEVO: helper para etiquetas de qty
      function qtyLabelFromQ(q){
        if (q === 1) return '1 Shilajit Detox';
        if (q === 2) return '1 Shilajit Detox + 1 H90';
        if (q === 3) return '1 Shilajit Detox + 1 M90';
        return `${q} productos`;
      }

      // Selección de oferta
      function selectOffer(card){
        offerCards.forEach(c=>c.classList.remove('active')); 
        card.classList.add('active');

        const price = Number(card.dataset.price)||0;
        const q = parseInt(card.dataset.qty, 10) || 1; // número de la oferta

        totalPrice.textContent = formatCOP(price);

        // Campos ocultos (fallback)
        const offerInput = form.querySelector('input[name="offer"]') || (()=>{const i=document.createElement('input');i.type='hidden';i.name='offer';form.appendChild(i);return i;})();
        const priceInput = form.querySelector('input[name="offer_price"]') || (()=>{const i=document.createElement('input');i.type='hidden';i.name='offer_price';form.appendChild(i);return i;})();

        offerInput.value = card.dataset.offer;
        priceInput.value = String(price);

        // Setear qty en hidden (texto y numérico) — SIEMPRE
        const qtyField = document.getElementById('qtyField');
        const qtyNumField = document.getElementById('qtyNumField');
        if (qtyField) qtyField.value = qtyLabelFromQ(q);
        if (qtyNumField) qtyNumField.value = String(q);

        // (si mantienes el select oculto, lo sincronizamos, pero ya no se usa para enviar)
        if (qtySelect) qtySelect.value = qtyLabelFromQ(q);

        selectedOffer = { offer: card.dataset.offer, qty: q, price };
        if (upsellModal.classList.contains('active')) updateUpsellTotals();
      }

      offerCards.forEach(c=>{
        c.addEventListener('click', ()=> selectOffer(c));
        c.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); selectOffer(c); } });
      });

      // Preselección segura
      selectOffer(offerCards[0]);

      // ===== Upsell =====
      function updateUpsellTotals(){
        const base = parseInt((selectedOffer?.price)||0,10)||0;
        const picked = document.querySelector('input[name="upsell_option"]:checked');
        const add = (!picked || picked.value==='Ninguno') ? 0 : 30000;
        upsellSubtotal.textContent = formatCOP(base);
        upsellAddon.textContent = formatCOP(add);
        upsellTotal.textContent = formatCOP(base + add);
        totalPrice.textContent = formatCOP(base + add);
      }
      function openUpsell(){
        const none = document.querySelector('input[name="upsell_option"][value="Ninguno"]');
        if (none) none.checked = true;
        updateUpsellTotals();
        upsellModal.classList.add('active'); upsellModal.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open');
      }
      function closeUpsell(){ upsellModal.classList.remove('active'); upsellModal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); }
      closeUpsellBtn.addEventListener('click', closeUpsell);
      document.querySelectorAll('input[name="upsell_option"]').forEach(r=> r.addEventListener('change', updateUpsellTotals));

      // Submit del form → no envía, abre upsell
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        formMsg.textContent = "";
        if (form.website && form.website.value !== "") return; // honeypot

        // Validación rápida
        const required = ['name','phone','state','city','address'];
        const invalid = [];
        required.forEach(k=>{
          const el = form.querySelector('[name="'+k+'"]');
          if (!el || !el.value.trim() || !el.checkValidity()) invalid.push(k);
        });
        if (invalid.length){
          formMsg.textContent = "Por favor completa todos los campos correctamente.";
          showToast("Completa los campos requeridos");
          invalid.forEach(k=>{ const el = form.querySelector('[name="'+k+'"]'); if (el) el.classList.add('error'); });
          return;
        }
        if (!selectedOffer){
          formMsg.textContent = "Selecciona una oferta antes de continuar.";
          showToast("Selecciona una oferta");
          return;
        }
        openUpsell(); // flujo: confirmar dentro del upsell
      });

      // Confirmar (envío real en JSON)
      upsellConfirm.addEventListener('click', async ()=>{
        try{
          submitBtn.disabled = true;
          const originalBtnText = submitBtn.querySelector('.btn-text')?.textContent || submitBtn.textContent;
          if (submitBtn.querySelector('.btn-text')) submitBtn.querySelector('.btn-text').textContent = "Enviando pedido...";

          // Upsell elegido
          const picked = document.querySelector('input[name="upsell_option"]:checked');
          const add = (!picked || picked.value === 'Ninguno') ? 0 : 30000;

          // Tomar qty desde los hidden seguros
          const qtyField = document.getElementById('qtyField');
          const qtyNumField = document.getElementById('qtyNumField');

          // Construye payload JSON
          const data = {
            name: form.name.value,
            phone: form.phone.value,
            state: form.state.value,
            city: form.city.value,
            address: form.address.value,

            qty: (qtyField?.value || ''),                     // Texto bonito
            qty_num: Number(qtyNumField?.value || 0),         // Número (1/2/3)

            // Oferta desde selección o desde hidden (fallback)
            offer: (selectedOffer?.offer) || (form.querySelector('input[name="offer"]')?.value || ''),
            offer_price: (selectedOffer?.price) || Number(form.querySelector('input[name="offer_price"]')?.value || 0),

            // Upsell
            upsell_type: (picked ? picked.value : 'Ninguno'),
            upsell_price: add
          };

          await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          // Éxito
          formMsg.textContent = "✅ Pedido enviado correctamente. Pronto te contactaremos.";
          showToast("✅ Pedido enviado correctamente");
          form.reset();
          totalPrice.textContent = "$0";
          closeUpsell();
          if (modal.classList.contains('active')) { modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); }

          if (submitBtn.querySelector('.btn-text')) submitBtn.querySelector('.btn-text').textContent = originalBtnText;
          submitBtn.disabled = false;
        } catch (err){
          console.error(err);
          formMsg.textContent = "❌ Hubo un error al enviar. Intenta nuevamente.";
          showToast("❌ Error al enviar");
          if (submitBtn.querySelector('.btn-text')) submitBtn.querySelector('.btn-text').textContent = "Confirmar pedido";
          submitBtn.disabled = false;
        }
      });

      // Limpia error al tipear
      form.querySelectorAll('.in').forEach(input => input.addEventListener('input', ()=> input.classList.remove('error')));

      // Lazy visible (opcional)
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver(entries=>{ entries.forEach(e=>{ if (e.isIntersecting) e.target.classList.add('visible'); }); }, { threshold:0.2 });
        document.querySelectorAll('img[loading="lazy"]').forEach(img=>observer.observe(img));
      }
    })();

    // ===== Contador 3h persistente por sesión =====
    const LS_KEY = 'zipper_countdown_end';
    const threeHours = 3*60*60*1000;
    let end = parseInt(localStorage.getItem(LS_KEY),10);
    if (!end || end < Date.now()) { end = Date.now() + threeHours; localStorage.setItem(LS_KEY, String(end)); }
    const th = document.getElementById('t-h'), tm = document.getElementById('t-m'), ts = document.getElementById('t-s');
    setInterval(()=>{
      const left = Math.max(0, end - Date.now());
      const h = String(Math.floor(left/3.6e6)).padStart(2,'0');
      const m = String(Math.floor(left%3.6e6/6e4)).padStart(2,'0');
      const s = String(Math.floor(left%6e4/1e3)).padStart(2,'0');
      th.textContent=h; tm.textContent=m; ts.textContent=s;
    },500);
  </script>
</body>
</html>
